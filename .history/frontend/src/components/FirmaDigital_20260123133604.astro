---
// Componente de Firma Digital - Versi√≥n Modal Responsive
---

<div class="firma-container">
  <label class="block text-sm font-medium text-gray-700 mb-2">
    Firma Digital <span class="text-red-500">*</span>
  </label>
  
  <div 
    id="abrir-firma"
    class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition group h-40 select-none"
  >
    <div id="estado-sin-firma" class="text-center">
      <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 text-2xl group-hover:scale-110 transition">
        ‚úçÔ∏è
      </div>
      <p class="text-blue-600 font-medium group-hover:underline">Click aqu√≠ para firmar</p>
      <p class="text-xs text-gray-500 mt-1">Se abrir√° en pantalla completa</p>
    </div>

    <img id="img-preview" class="hidden max-h-32 w-auto object-contain pointer-events-none" alt="Firma realizada" />
    <p id="texto-cambiar" class="hidden text-xs text-blue-600 mt-2 underline">Click para cambiar firma</p>
  </div>

  <input type="hidden" id="firma_digital" name="firma_digital" required />
  
  <p class="text-xs text-gray-500 mt-2">
    ‚ÑπÔ∏è Su firma digital tiene validez legal seg√∫n Ley N¬∞ 27269
  </p>
</div>

<div id="modal-firma" class="hidden fixed inset-0 z-50 bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden flex flex-col h-[85vh] md:h-auto md:aspect-[3/2]">
    
    <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center shrink-0">
      <h3 class="font-bold text-gray-800 flex items-center gap-2">
        <span>‚úçÔ∏è</span> Realice su firma
      </h3>
      <button type="button" id="cerrar-x" class="text-gray-400 hover:text-red-500 text-2xl leading-none font-bold px-2">&times;</button>
    </div>

    <div id="canvas-wrapper" class="flex-1 bg-white relative cursor-crosshair touch-none overflow-hidden">
        <canvas id="signature-canvas" class="block w-full h-full"></canvas>
        
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-100 text-5xl font-bold pointer-events-none select-none tracking-widest">
            FIRMAR
        </div>
    </div>

    <div class="bg-gray-50 px-4 py-4 border-t flex flex-col sm:flex-row justify-between gap-3 shrink-0">
        <button 
            type="button" 
            id="btn-limpiar" 
            class="px-4 py-3 sm:py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 font-medium transition flex items-center justify-center gap-2"
        >
            üóëÔ∏è Borrar
        </button>
        
        <div class="flex gap-3 w-full sm:w-auto">
            <button 
                type="button" 
                id="btn-cancelar" 
                class="flex-1 sm:flex-none px-4 py-3 sm:py-2 text-gray-600 font-medium hover:text-gray-800 hover:bg-gray-100 rounded-lg transition text-center"
            >
                Cancelar
            </button>
            <button 
                type="button" 
                id="btn-guardar" 
                class="flex-1 sm:flex-none px-6 py-3 sm:py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition transform active:scale-95 flex items-center justify-center gap-2"
            >
                ‚úÖ Aceptar Firma
            </button>
        </div>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  import SignaturePad from 'https://cdn.jsdelivr.net/npm/signature_pad@5.0.0/+esm';

  // --- REFERENCIAS DOM ---
  const btnAbrir = document.getElementById('abrir-firma');
  const modal = document.getElementById('modal-firma');
  const canvas = document.getElementById('signature-canvas');
  const wrapper = document.getElementById('canvas-wrapper');
  const hiddenInput = document.getElementById('firma_digital');
  
  // UI Estado
  const sinFirmaDiv = document.getElementById('estado-sin-firma');
  const imgPreview = document.getElementById('img-preview');
  const textoCambiar = document.getElementById('texto-cambiar');

  // Botones Modal
  const btnGuardar = document.getElementById('btn-guardar');
  const btnLimpiar = document.getElementById('btn-limpiar');
  const btnCancelar = document.getElementById('btn-cancelar');
  const btnCerrarX = document.getElementById('cerrar-x');

  let signaturePad = null;
  let resizeObserver = null;

  // --- INICIALIZAR PAD ---
  function initPad() {
    if (!canvas || signaturePad) return;
    
    signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)', // Transparente
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1.5,
        maxWidth: 3.5,
        throttle: 16
    });
  }

  // --- REDIMENSIONAR CANVAS (Responsive) ---
  function resizeCanvas() {
    if (!canvas || !wrapper || !signaturePad) return;
    
    // Guardamos trazos actuales
    const data = signaturePad.toData();
    
    // Obtenemos ratio del dispositivo y dimensiones reales
    const ratio = Math.max(window.devicePixelRatio || 1, 1);