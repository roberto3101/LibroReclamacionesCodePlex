---
// Componente de Firma Digital
---
<div class="firma-digital-container">
  <label class="block text-sm font-medium text-gray-700 mb-2">
    Firma Digital <span class="text-red-500">*</span>
  </label>
  <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
    <p class="text-sm text-gray-600 mb-3">
      Firme con su dedo o mouse en el recuadro para dar conformidad:
    </p>
    <div id="signature-wrapper" class="border-2 border-gray-400 rounded bg-white">
      <canvas
        id="signature-canvas"
        class="cursor-crosshair"
        style="touch-action: none; width: 100%; height: 200px; display: block;"
      ></canvas>
    </div>
    <div class="flex gap-3 mt-3">
      <button
        type="button"
        id="clear-signature"
        class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition"
      >
        ğŸ—‘ï¸ Limpiar
      </button>
      <button
        type="button"
        id="undo-signature"
        class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition"
      >
        â†¶ Deshacer
      </button>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      â„¹ï¸ Su firma digital tiene validez legal segÃºn Ley NÂ° 27269
    </p>
  </div>
  <input type="hidden" id="firma_digital" name="firma_digital" required />
</div>

<!-- Cargar SignaturePad desde CDN con script tag -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.0/dist/signature_pad.umd.min.js"></script>

<script is:inline>
  (function() {
    function initSignaturePad() {
      // @ts-ignore - SignaturePad se carga desde CDN
      if (typeof SignaturePad === 'undefined') {
        setTimeout(initSignaturePad, 100);
        return;
      }
      
      const canvas = document.getElementById('signature-canvas');
      const hiddenInput = document.getElementById('firma_digital');
      
      if (!canvas || !hiddenInput) return;
      
      let signaturePad = null;
      
      function resizeCanvas() {
        // Obtener el tamaÃ±o real del canvas en pantalla
        const rect = canvas.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        
        // Establecer el tamaÃ±o interno del canvas
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        
        // Escalar el contexto para que coincida con el DPI
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        
        // Rellenar con fondo blanco
        ctx.fillStyle = 'rgb(255, 255, 255)';
        ctx.fillRect(0, 0, rect.width, rect.height);
      }
      
      // Inicializar tamaÃ±o del canvas
      resizeCanvas();
      
      // @ts-ignore
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 0.5,
        maxWidth: 2.5
      });
      
      // Manejar redimensionamiento
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          const data = signaturePad.toData();
          resizeCanvas();
          signaturePad.clear();
          if (data && data.length > 0) {
            signaturePad.fromData(data);
          }
        }, 200);
      });
      
      // Guardar firma cuando termine de dibujar
      signaturePad.addEventListener('endStroke', function() {
        if (!signaturePad.isEmpty()) {
          hiddenInput.value = signaturePad.toDataURL('image/png');
        }
      });
      
      // BotÃ³n limpiar
      document.getElementById('clear-signature').addEventListener('click', function() {
        signaturePad.clear();
        hiddenInput.value = '';
        // Redibujar fondo blanco
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        ctx.fillStyle = 'rgb(255, 255, 255)';
        ctx.fillRect(0, 0, rect.width, rect.height);
      });
      
      // BotÃ³n deshacer
      document.getElementById('undo-signature').addEventListener('click', function() {
        const data = signaturePad.toData();
        if (data && data.length > 0) {
          data.pop();
          signaturePad.fromData(data);
          hiddenInput.value = signaturePad.isEmpty() ? '' : signaturePad.toDataURL('image/png');
        }
      });
    }
    
    // Esperar a que el DOM estÃ© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSignaturePad);
    } else {
      initSignaturePad();
    }
  })();
</script>